<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Stock Watchlist v2</title>
<style>
:root{--bg:#0d1117;--s1:#161b22;--s2:#1c2333;--s3:#21262d;--border:#30363d;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--warn:#f0883e;--gold:#d29922;--purple:#bc8cff;--teal:#39d353;--text:#e6edf3;--muted:#8b949e;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:14px;min-height:100vh;}
.setup-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse at 50% 0%,#1c2333 0%,#0d1117 70%);}
.setup-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:480px;text-align:center;}
.setup-icon{font-size:48px;margin-bottom:14px;}
.setup-card h1{font-size:21px;font-weight:800;margin-bottom:6px;}
.setup-card p{color:var(--muted);font-size:13px;margin-bottom:26px;line-height:1.7;}
.setup-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;color:var(--text);font-size:13px;font-family:monospace;margin-bottom:12px;transition:border-color .2s;}
.setup-input:focus{outline:none;border-color:var(--accent);}
.setup-btn{width:100%;padding:13px;border-radius:8px;border:none;background:var(--accent);color:#000;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;margin-bottom:8px;}
.setup-btn:hover{background:#79b8ff;}
.setup-btn:disabled{opacity:.5;cursor:not-allowed;}
.setup-btn-sec{width:100%;padding:11px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:13px;cursor:pointer;}
.setup-btn-sec:hover{border-color:var(--accent);color:var(--accent);}
.setup-status{margin-top:12px;font-size:13px;min-height:18px;}
.setup-status.ok{color:var(--green);}
.setup-status.err{color:var(--red);}
.fh-screen{display:none;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse at 50% 0%,#1c2333 0%,#0d1117 70%);}
#app{display:none;}
.rbar{height:2px;background:var(--border);}
.rprog{height:100%;background:var(--accent);}
.hdr{background:linear-gradient(135deg,#0d1117,#161b22);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.hdr h1{font-size:19px;font-weight:800;}
.hdr-sub{color:var(--muted);font-size:11px;margin-top:1px;}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.mkt{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.mkt-o{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3);}
.mkt-c{background:rgba(248,81,73,.1);color:var(--red);border:1px solid rgba(248,81,73,.3);}
.mkt-p{background:rgba(210,153,34,.1);color:var(--gold);border:1px solid rgba(210,153,34,.3);}
.clk{color:var(--muted);font-size:12px;font-family:monospace;}
.spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;display:none;animation:rot .8s linear infinite;}
@keyframes rot{to{transform:rotate(360deg)}}
.ibtn{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);padding:5px 10px;cursor:pointer;font-size:12px;}
.ibtn:hover{border-color:var(--accent);color:var(--accent);}
.sync-badge{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:4px 9px;}
.sd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.sd-on{background:var(--green);animation:pulse 2s infinite;}
.sd-off{background:var(--red);}
.sd-spin{background:var(--gold);animation:pulse .5s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.pbar{background:var(--s1);border-bottom:1px solid var(--border);padding:9px 20px;display:flex;gap:6px;overflow-x:auto;align-items:center;}
.plbl{font-size:10px;font-weight:700;color:var(--muted);white-space:nowrap;margin-right:4px;}
.pi{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:7px 12px;min-width:110px;}
.psym{font-size:10px;font-weight:800;color:var(--muted);}
.ppr{font-size:14px;font-weight:800;margin:2px 0;}
.pch{font-size:11px;font-weight:700;}
/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--border);padding:0 20px;overflow-x:auto;}
.tab{padding:11px 14px;cursor:pointer;border-bottom:3px solid transparent;font-weight:700;font-size:12px;color:var(--muted);white-space:nowrap;transition:all .2s;display:flex;align-items:center;gap:5px;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab[data-list="weekly"].active{color:var(--gold);border-bottom-color:var(--gold);}
.tab[data-list="daily"].active{color:var(--green);border-bottom-color:var(--green);}
.tab[data-list="ondeck"].active{color:var(--purple);border-bottom-color:var(--purple);}
.tab[data-list="rs"].active{color:var(--teal);border-bottom-color:var(--teal);}
.tc{background:var(--s2);color:var(--muted);border-radius:10px;padding:1px 6px;font-size:10px;}
.tab[data-list="weekly"] .tc{background:rgba(210,153,34,.15);color:var(--gold);}
.tab[data-list="daily"] .tc{background:rgba(63,185,80,.15);color:var(--green);}
.tab[data-list="ondeck"] .tc{background:rgba(188,140,255,.15);color:var(--purple);}
.tab[data-list="rs"] .tc{background:rgba(57,211,83,.15);color:var(--teal);}
/* â”€â”€ CONTROL BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ctrl{padding:10px 20px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);background:var(--s1);}
.sw{position:relative;flex:1;min-width:180px;}
.sw input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:7px 11px 7px 32px;color:var(--text);font-size:13px;}
.sw input:focus{outline:none;border-color:var(--accent);}
.si{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px;}
.btn{padding:7px 13px;border-radius:7px;border:none;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;}
.bp{background:var(--accent);color:#000;}
.bp:hover{background:#79b8ff;}
.bs{background:var(--s2);color:var(--text);border:1px solid var(--border);}
.vt{display:flex;background:var(--s2);border:1px solid var(--border);border-radius:7px;overflow:hidden;}
.vb{padding:7px 11px;cursor:pointer;font-size:12px;font-weight:700;color:var(--muted);border:none;background:transparent;}
.vb.active{background:var(--accent);color:#000;}
.ss{background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:7px 9px;color:var(--text);font-size:12px;cursor:pointer;}
/* â”€â”€ STATS SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ssum{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.ssc{background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:11px 14px;flex:1;min-width:120px;}
.ssl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;}
.ssv{font-size:17px;font-weight:800;}
.sss{font-size:11px;color:var(--muted);margin-top:2px;}
/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tw{overflow-x:auto;border-radius:10px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{background:var(--s2);padding:8px 10px;text-align:left;color:var(--muted);font-weight:700;font-size:10px;text-transform:uppercase;border-bottom:2px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;}
td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;white-space:nowrap;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.03);}
.tu{color:var(--green);font-weight:700;}
.td{color:var(--red);font-weight:700;}
.sk{background:linear-gradient(90deg,var(--s2) 25%,var(--s3) 50%,var(--s2) 75%);background-size:200% 100%;animation:sh 1.5s infinite;border-radius:4px;height:13px;width:55px;display:inline-block;}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
.pbar2{height:4px;border-radius:2px;min-width:2px;max-width:48px;display:inline-block;}
.pu{background:var(--green);}
.pd{background:var(--red);}
/* â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sbadge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:800;}
.s1b{background:rgba(210,153,34,.15);color:var(--gold);}
.s2x{background:rgba(63,185,80,.15);color:var(--green);}
.s2c{background:rgba(88,166,255,.15);color:var(--accent);}
.s3x{background:rgba(240,136,62,.15);color:var(--warn);}
.s4x{background:rgba(248,81,73,.15);color:var(--red);}
.stag{padding:2px 6px;border-radius:4px;font-size:10px;background:var(--s3);color:var(--muted);}
.ab{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;}
.ab-a{background:rgba(63,185,80,.15);color:var(--green);}
.ab-b{background:rgba(248,81,73,.15);color:var(--red);}
.ab-h{background:rgba(210,153,34,.3);color:var(--gold);animation:alp 1s infinite;}
@keyframes alp{0%,100%{opacity:1}50%{opacity:.4}}
/* â”€â”€ LIST INDICATOR PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lpill{padding:2px 7px;border-radius:10px;font-size:10px;font-weight:700;}
.lp-weekly{background:rgba(210,153,34,.15);color:var(--gold);border:1px solid rgba(210,153,34,.3);}
.lp-daily{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3);}
.lp-ondeck{background:rgba(188,140,255,.15);color:var(--purple);border:1px solid rgba(188,140,255,.3);}
.lp-rs{background:rgba(57,211,83,.15);color:var(--teal);border:1px solid rgba(57,211,83,.3);}
.lp-all{background:var(--s3);color:var(--muted);}
/* â”€â”€ RS RATING BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.emd{width:7px;height:7px;border-radius:50%;display:inline-block;}
.eo{background:var(--green);}
.enb{background:var(--red);}
.rsb{height:5px;border-radius:3px;background:var(--s3);overflow:hidden;width:42px;margin-top:2px;}
.rsf{height:100%;background:linear-gradient(90deg,var(--warn),var(--green));border-radius:3px;}
/* â”€â”€ RS RANK INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rs-rank{display:inline-flex;align-items:center;gap:4px;}
.rs-star{color:var(--gold);font-size:11px;}
/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;}
.scard{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:15px;transition:all .2s;position:relative;overflow:hidden;}
.scard:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3);}
.csb{position:absolute;left:0;top:0;bottom:0;width:3px;}
.ct{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.ctk{font-size:17px;font-weight:900;}
.ccn{font-size:11px;color:var(--muted);margin-top:2px;}
.cpr{font-size:19px;font-weight:800;margin-bottom:9px;}
.cpf{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:9px;}
.cpe{background:var(--s2);border-radius:6px;padding:6px;text-align:center;}
.cpl{font-size:9px;color:var(--muted);text-transform:uppercase;}
.cpv{font-size:12px;font-weight:800;margin-top:2px;}
.cf{display:flex;justify-content:space-between;align-items:center;}
.apd{position:absolute;top:11px;right:11px;width:7px;height:7px;border-radius:50%;background:var(--gold);animation:alp 1.5s infinite;}
/* â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center;padding:20px;}
.mo.open{display:flex;}
.md{background:var(--s1);border:1px solid var(--border);border-radius:14px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;}
.mh{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.mh h2{font-size:14px;font-weight:800;}
.mcb{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;}
.mb{padding:18px;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.ff{display:flex;flex-direction:column;gap:4px;}
.ff label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.ff input,.ff select,.ff textarea{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:7px 10px;color:var(--text);font-size:13px;font-family:inherit;transition:border-color .2s;}
.ff input:focus,.ff select:focus,.ff textarea:focus{outline:none;border-color:var(--accent);}
.ff textarea{min-height:60px;resize:vertical;}
.full{grid-column:1/-1;}
.mf{padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;}
.lr{display:flex;gap:7px;}
.lr input{flex:1;}
.lb{padding:7px 12px;border-radius:7px;border:none;background:var(--accent);color:#000;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;}
.lb:disabled{opacity:.5;cursor:not-allowed;}
.ls{font-size:11px;color:var(--muted);margin-top:3px;min-height:16px;}
/* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.set-sec{margin-bottom:18px;}
.set-sec h3{font-size:12px;font-weight:700;margin-bottom:10px;}
.set-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.set-row:last-child{border-bottom:none;}
.tog{width:38px;height:21px;border-radius:11px;background:var(--s3);border:none;cursor:pointer;position:relative;transition:background .2s;}
.tog.on{background:var(--green);}
.tog::after{content:'';position:absolute;width:15px;height:15px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left .2s;}
.tog.on::after{left:20px;}
/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:11px 16px;font-size:13px;font-weight:600;z-index:2000;transform:translateY(80px);opacity:0;transition:all .3s;max-width:300px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.err{border-color:var(--red);color:var(--red);}
.toast.info{border-color:var(--accent);color:var(--accent);}
/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{padding:16px 20px;max-width:1600px;margin:0 auto;}
.empty{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-icon{font-size:44px;margin-bottom:14px;}
/* â”€â”€ SECTION HEADER (weekly/daily visual) â”€â”€â”€ */
.list-banner{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:10px 14px;border-radius:8px;border-left:3px solid;}
.list-banner.weekly{background:rgba(210,153,34,.06);border-color:var(--gold);}
.list-banner.daily{background:rgba(63,185,80,.06);border-color:var(--green);}
.list-banner.ondeck{background:rgba(188,140,255,.06);border-color:var(--purple);}
.list-banner.rs{background:rgba(57,211,83,.06);border-color:var(--teal);}
.list-banner.all{background:rgba(88,166,255,.06);border-color:var(--accent);}
.lb-icon{font-size:20px;}
.lb-title{font-size:13px;font-weight:800;}
.lb-desc{font-size:11px;color:var(--muted);margin-top:1px;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
@media(max-width:600px){.fg{grid-template-columns:1fr;}.full{grid-column:1/1;}}
</style>
</head>
<body>

<!-- Finnhub setup screen -->
<div class="fh-screen" id="fh-screen">
  <div class="setup-card">
    <div class="setup-icon">ğŸ“Š</div>
    <h1>Pro Stock Watchlist</h1>
    <p>Optionally enter a free <a href="https://finnhub.io" target="_blank" style="color:var(--accent)">Finnhub API key</a> for live prices.<br>You can also track setups manually without live prices.</p>
    <input class="setup-input" id="fh-key-input" type="password" placeholder="Paste Finnhub API key (optional)...">
    <button class="setup-btn" id="fh-btn" onclick="connectFinnhub()">ğŸ“¡ Connect Live Prices &amp; Launch</button>
    <button class="setup-btn-sec" onclick="skipFinnhub()">ğŸš€ Launch Without Live Prices</button>
    <div class="setup-status" id="fh-status"></div>
  </div>
</div>

<div id="app">
  <div class="rbar"><div class="rprog" id="rprog" style="width:100%;transition:width 1s linear;"></div></div>
  <div class="hdr">
    <span style="font-size:24px">ğŸ“Š</span>
    <div><h1>Pro Stock Watchlist</h1><div class="hdr-sub" id="last-upd">Loading...</div></div>
    <div class="hdr-right">
      <div class="sync-badge" id="sync-badge"><div class="sd sd-spin" id="sync-dot"></div><span id="sync-lbl">Syncing...</span></div>
      <div class="clk" id="clk"></div>
      <div class="mkt mkt-c" id="mkt">â— LOADING</div>
      <div class="spin" id="spin"></div>
      <button class="ibtn" onclick="openSettings()">âš™ï¸</button>
    </div>
  </div>

  <!-- Index Price Bar -->
  <div class="pbar">
    <span class="plbl">INDICES</span>
    <div class="pi"><div class="psym">SPY</div><div id="p-SPY-p" style="color:var(--muted);font-size:11px">â€”</div><div id="p-SPY-c" class="pch"></div></div>
    <div class="pi"><div class="psym">QQQ</div><div id="p-QQQ-p" style="color:var(--muted);font-size:11px">â€”</div><div id="p-QQQ-c" class="pch"></div></div>
    <div class="pi"><div class="psym">IWM</div><div id="p-IWM-p" style="color:var(--muted);font-size:11px">â€”</div><div id="p-IWM-c" class="pch"></div></div>
    <div class="pi"><div class="psym">VIX</div><div id="p-VIX-p" style="color:var(--muted);font-size:11px">â€”</div><div id="p-VIX-c" class="pch"></div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-list="all" onclick="switchTab('all',this)">ğŸ“‹ All Stocks <span class="tc" id="c-all">0</span></div>
    <div class="tab" data-list="weekly" onclick="switchTab('weekly',this)">ğŸ“† Weekly List <span class="tc" id="c-weekly">0</span></div>
    <div class="tab" data-list="daily" onclick="switchTab('daily',this)">ğŸ•¯ Daily List <span class="tc" id="c-daily">0</span></div>
    <div class="tab" data-list="ondeck" onclick="switchTab('ondeck',this)">ğŸ‘€ On Deck <span class="tc" id="c-ondeck">0</span></div>
    <div class="tab" data-list="rs" onclick="switchTab('rs',this)">âš¡ Relative Strength <span class="tc" id="c-rs">0</span></div>
    <div class="tab" data-list="alerts" onclick="switchTab('alerts',this)">ğŸ”” Alerts <span class="tc" id="c-alerts">0</span></div>
  </div>

  <!-- Controls -->
  <div class="ctrl">
    <div class="sw"><span class="si">ğŸ”</span><input type="text" id="srch" placeholder="Search ticker, company, sector..." oninput="renderWL()"></div>
    <select class="ss" id="srt" onchange="renderWL()">
      <option value="added">Date Added</option>
      <option value="ticker">Ticker A-Z</option>
      <option value="daily_d">Daily % â†“</option>
      <option value="daily_a">Daily % â†‘</option>
      <option value="weekly_d">Weekly % â†“</option>
      <option value="monthly_d">Monthly % â†“</option>
      <option value="price_d">Price â†“</option>
      <option value="rs_d">RS Rating â†“</option>
    </select>
    <div class="vt">
      <button class="vb active" id="vbt" onclick="setView('table')">â˜° Table</button>
      <button class="vb" id="vbc" onclick="setView('card')">âŠ Cards</button>
    </div>
    <button class="btn bp" onclick="openAdd()">ï¼‹ Add Stock</button>
    <button class="btn bs" onclick="manualRef()">âŸ³ Refresh</button>
  </div>

  <div class="main"><div class="ssum" id="ssum"></div><div id="wl"></div></div>
</div>

<!-- Add/Edit Modal -->
<div class="mo" id="stock-mo">
  <div class="md">
    <div class="mh"><h2 id="mo-title">Add Stock</h2><button class="mcb" onclick="closeSMo()">âœ•</button></div>
    <div class="mb">
      <div class="fg">
        <div class="ff full"><label>Ticker</label>
          <div class="lr"><input type="text" id="f-tk" placeholder="AAPL" style="text-transform:uppercase;font-weight:800;font-size:15px;" oninput="this.value=this.value.toUpperCase()"><button class="lb" id="lu-btn" onclick="lookupTk()">ğŸ” Lookup</button></div>
          <div class="ls" id="lu-st"></div>
        </div>
        <div class="ff"><label>Company Name</label><input type="text" id="f-co" placeholder="Auto-filled or enter manually"></div>
        <div class="ff"><label>Sector</label>
          <select id="f-se">
            <option value="">Select...</option>
            <option>Technology</option><option>Healthcare</option><option>Financials</option>
            <option>Consumer Disc.</option><option>Industrials</option><option>Energy</option>
            <option>Materials</option><option>Real Estate</option><option>Utilities</option>
            <option>Communication</option><option>Consumer Staples</option>
          </select>
        </div>
        <div class="ff"><label>Watchlist</label>
          <select id="f-li">
            <option value="all">All Stocks</option>
            <option value="weekly">ğŸ“† Weekly List</option>
            <option value="daily">ğŸ•¯ Daily List</option>
            <option value="ondeck">ğŸ‘€ On Deck</option>
            <option value="rs">âš¡ Relative Strength</option>
          </select>
        </div>
        <div class="ff"><label>Stage (Weinstein)</label>
          <select id="f-st">
            <option value="Stage 2">Stage 2</option>
            <option value="Stage 1A">Stage 1A</option>
            <option value="Stage 1B">Stage 1B</option>
            <option value="Stage 2C">Stage 2C (Cont.)</option>
            <option value="Stage 3">Stage 3</option>
            <option value="Stage 4">Stage 4</option>
          </select>
        </div>
        <div class="ff"><label>RS Rating (1â€“99)</label><input type="number" id="f-rs" placeholder="85" min="1" max="99"></div>
        <div class="ff"><label>EMA 10 &gt; EMA 20</label>
          <select id="f-em"><option value="yes">âœ… Yes</option><option value="no">âŒ No</option></select>
        </div>
        <div class="ff"><label>Above 50-day SMA</label>
          <select id="f-50"><option value="yes">âœ… Yes</option><option value="no">âŒ No</option></select>
        </div>
        <div class="ff"><label>Alert Above ($)</label><input type="number" id="f-aa" placeholder="0.00" step="0.01"></div>
        <div class="ff"><label>Alert Below ($)</label><input type="number" id="f-ab" placeholder="0.00" step="0.01"></div>
        <!-- Weekly-specific fields -->
        <div class="ff"><label>Weekly Timeframe Setup</label>
          <select id="f-wf">
            <option value="">â€”</option>
            <option value="Base Breakout">Base Breakout</option>
            <option value="Bull Flag">Bull Flag</option>
            <option value="Consolidation">Consolidation</option>
            <option value="Stage 2 Entry">Stage 2 Entry</option>
            <option value="40-Week Hold">40-Week Hold</option>
            <option value="VCP">VCP</option>
            <option value="Cup & Handle">Cup &amp; Handle</option>
          </select>
        </div>
        <!-- RS-specific field -->
        <div class="ff"><label>RS New High</label>
          <select id="f-rsh"><option value="no">âŒ No</option><option value="yes">âœ… Yes â€” RS New High</option></select>
        </div>
        <div class="ff full"><label>Setup Notes</label><textarea id="f-nt" placeholder="Stage 2 breakout, RS new high, weekly base week 8..."></textarea></div>
      </div>
    </div>
    <div class="mf"><button class="btn bs" onclick="closeSMo()">Cancel</button><button class="btn bp" onclick="saveStk()">ğŸ’¾ Save & Sync</button></div>
  </div>
</div>

<!-- Settings Modal -->
<div class="mo" id="set-mo">
  <div class="md" style="max-width:440px;">
    <div class="mh"><h2>âš™ï¸ Settings</h2><button class="mcb" onclick="closeSet()">âœ•</button></div>
    <div class="mb">
      <div class="set-sec"><h3>ğŸ”— JSONBin Sync</h3>
        <div class="ff"><label>Master Key</label><div class="lr"><input type="password" id="set-jb" placeholder="$2a$10$..."><button class="lb" onclick="updateJB()">Save</button></div></div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px">Bin ID: <span id="set-bin-id" style="font-family:monospace;font-size:10px"></span></div>
      </div>
      <div class="set-sec"><h3>ğŸ“¡ Finnhub API Key</h3>
        <div class="ff"><label>API Key</label><div class="lr"><input type="password" id="set-fh" placeholder="Your Finnhub key"><button class="lb" onclick="updateFH()">Save</button></div></div>
      </div>
      <div class="set-sec"><h3>ğŸ”„ Auto-Refresh</h3>
        <div class="set-row"><div style="font-size:13px">Auto-refresh prices</div><button class="tog on" id="ar-tog" onclick="toggleAR()"></button></div>
        <div class="set-row"><div style="font-size:13px">Interval</div>
          <select class="ss" id="ri-sel" onchange="updateRI()">
            <option value="30">30 sec</option><option value="60" selected>60 sec</option>
            <option value="120">2 min</option><option value="300">5 min</option>
          </select>
        </div>
      </div>
      <div class="set-sec"><h3>âš ï¸ Danger Zone</h3>
        <div class="set-row"><div style="font-size:13px">Delete all stocks</div><button class="btn" style="background:rgba(248,81,73,.15);color:var(--red);border:1px solid rgba(248,81,73,.3)" onclick="clearAll()">Delete All</button></div>
        <div class="set-row"><div style="font-size:13px">Reset & re-enter keys</div><button class="btn bs" onclick="resetAll()">Reset</button></div>
      </div>
    </div>
    <div class="mf"><button class="btn bp" onclick="closeSet()">Done</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var DEFAULT_JB_KEY = '$2a$10$WF5jPGoc0jlc95Vs9/hoZu00G67HNvu3MH7EDLjfxac8GBz/yz8NS';
  var DEFAULT_BIN_ID = '699d20ef43b1c97be9985dcd';
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  var JB_BASE = 'https://api.jsonbin.io/v3';
  var FH_BASE = 'https://finnhub.io/api/v1';

  var JB_KEY  = localStorage.getItem('jb_key')  || DEFAULT_JB_KEY;
  var BIN_ID  = localStorage.getItem('jb_bin')  || DEFAULT_BIN_ID;
  var FH_KEY  = localStorage.getItem('fh_key')  || '';
  var LIVE    = !!FH_KEY;
  var stocks  = JSON.parse(localStorage.getItem('wl_local2') || '[]');
  var prices  = {}, wkO = {}, moO = {};
  var curTab  = 'all', curView = 'table';
  var editId  = null;
  var autoRef = true, refInt = 60, countdown = 60;
  var refTimer = null, syncTimer = null;

  localStorage.setItem('jb_key', JB_KEY);
  localStorage.setItem('jb_bin', BIN_ID);

  // â”€â”€ LIST CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var LIST_META = {
    all:     {icon:'ğŸ“‹', label:'All Stocks',        desc:'Every stock across all watchlists',                          color:'var(--accent)',  cls:'all'},
    weekly:  {icon:'ğŸ“†', label:'Weekly List',        desc:'Weekly chart setups â€” base patterns, stage 2 candidates',   color:'var(--gold)',    cls:'weekly'},
    daily:   {icon:'ğŸ•¯', label:'Daily List',         desc:'Daily chart setups â€” flags, breakouts, intraday triggers',  color:'var(--green)',   cls:'daily'},
    ondeck:  {icon:'ğŸ‘€', label:'On Deck',            desc:'Almost ready â€” watching for entry trigger',                 color:'var(--purple)',  cls:'ondeck'},
    rs:      {icon:'âš¡', label:'Relative Strength',  desc:'Leaders showing RS new highs & outperforming the market',  color:'var(--teal)',    cls:'rs'},
    alerts:  {icon:'ğŸ””', label:'Alerts',             desc:'Price alerts triggered',                                    color:'var(--warn)',    cls:'all'}
  };

  // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setFS(m,c){var e=document.getElementById('fh-status');e.textContent=m;e.className='setup-status '+(c||'');}
  function setLU(m,t){var e=document.getElementById('lu-st');e.textContent=m;e.style.color=t==='ok'?'var(--green)':t==='err'?'var(--red)':'var(--muted)';}
  function setSyncStatus(state,label){
    var dot=document.getElementById('sync-dot'),lbl=document.getElementById('sync-lbl');
    if(dot) dot.className='sd '+(state==='on'?'sd-on':state==='off'?'sd-off':'sd-spin');
    if(lbl) lbl.textContent=label;
  }
  function showToast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast '+(t||'success')+' show';setTimeout(function(){e.classList.remove('show');},3500);}

  // â”€â”€ FINNHUB SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.connectFinnhub = async function(){
    var k=document.getElementById('fh-key-input').value.trim();
    if(!k){setFS('Enter your API key','err');return;}
    var btn=document.getElementById('fh-btn');btn.disabled=true;btn.textContent='â³ Validating...';
    try{
      var r=await fetch(FH_BASE+'/quote?symbol=SPY&token='+k);
      var d=await r.json();
      if(d.c&&d.c>0){FH_KEY=k;LIVE=true;localStorage.setItem('fh_key',k);setFS('âœ… Connected! Launching...','ok');setTimeout(launchApp,700);}
      else throw new Error('bad');
    }catch(e){setFS('âŒ Invalid key. Try again.','err');btn.disabled=false;btn.textContent='ğŸ“Š Validate & Launch';}
  };
  window.skipFinnhub = function(){LIVE=false;localStorage.setItem('fh_skipped','1');launchApp();};

  // â”€â”€ LAUNCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function launchApp(){
    document.getElementById('fh-screen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('set-bin-id').textContent=BIN_ID;
    updateClock(); setInterval(updateClock,1000);
    setSyncStatus('spin','Loading from cloud...');
    await pullFromBin();
    startSyncTimer();
    if(LIVE){showToast('ğŸ“¡ Loading live prices...','info');fetchAll();startRefTimer();}
    document.addEventListener('visibilitychange',function(){if(!document.hidden)pullFromBin();});
  }

  // â”€â”€ JSONBIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveToBin(){
    localStorage.setItem('wl_local2',JSON.stringify(stocks));
    var r=await fetch(JB_BASE+'/b/'+BIN_ID,{method:'PUT',headers:{'X-Master-Key':JB_KEY,'Content-Type':'application/json'},body:JSON.stringify({stocks:stocks,finnhubKey:FH_KEY,version:Date.now()})});
    if(!r.ok){var t=await r.text();throw new Error('Save failed: '+r.status+' '+t);}
    setSyncStatus('on','Synced '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}));
  }

  async function pullFromBin(){
    try{
      setSyncStatus('spin','Syncing...');
      var r=await fetch(JB_BASE+'/b/'+BIN_ID+'/latest',{headers:{'X-Master-Key':JB_KEY}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      var d=await r.json();
      if(d.record&&d.record.stocks){
        stocks=d.record.stocks;
        if(d.record.finnhubKey&&!FH_KEY){FH_KEY=d.record.finnhubKey;LIVE=true;localStorage.setItem('fh_key',FH_KEY);}
        localStorage.setItem('wl_local2',JSON.stringify(stocks));
        renderWL();
      }
      setSyncStatus('on','Synced '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}));
    }catch(e){setSyncStatus('off','Sync error: '+e.message);console.error('pullFromBin',e);}
  }

  function startSyncTimer(){if(syncTimer)clearInterval(syncTimer);syncTimer=setInterval(pullFromBin,5*60*1000);}

  // â”€â”€ CLOCK & MARKET STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateClock(){
    var est=new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));
    var h=est.getHours(),m=est.getMinutes(),s=est.getSeconds();
    var clk=document.getElementById('clk');
    if(clk) clk.textContent=(String(h%12||12).padStart(2,'0'))+':'+(String(m).padStart(2,'0'))+':'+(String(s).padStart(2,'0'))+' '+(h>=12?'PM':'AM')+' ET';
    var day=est.getDay(),min=h*60+m,el=document.getElementById('mkt');
    if(!el)return;
    if(day===0||day===6||min>=960){el.textContent='â— MARKET CLOSED';el.className='mkt mkt-c';}
    else if(min>=570&&min<630){el.textContent='â— PRE-MARKET';el.className='mkt mkt-p';}
    else if(min>=630&&min<960){el.textContent='â— MARKET OPEN';el.className='mkt mkt-o';}
    else{el.textContent='â— MARKET CLOSED';el.className='mkt mkt-c';}
  }

  // â”€â”€ PRICE FETCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var fq=[],fb=false;
  function apiFetch(url){return new Promise(function(res,rej){fq.push({url:url,res:res,rej:rej});if(!fb)runFQ();});}
  async function runFQ(){fb=true;while(fq.length){var item=fq.shift();try{var r=await fetch(item.url);if(!r.ok)throw new Error(r.status);item.res(await r.json());}catch(e){item.rej(e);}if(fq.length)await new Promise(function(r){setTimeout(r,1050);});}fb=false;}
  function moStart(){var n=new Date();return Math.floor(new Date(n.getFullYear(),n.getMonth(),1).getTime()/1000);}
  function mondayIdx(ts){var n=new Date(),d=n.getDay(),diff=d===0?6:d-1,mon=new Date(n);mon.setDate(n.getDate()-diff);mon.setHours(0,0,0,0);var mts=mon.getTime()/1000;for(var i=0;i<ts.length;i++){if(ts[i]>=mts)return i;}return 0;}

  async function fetchAll(){
    document.getElementById('spin').style.display='block';
    for(var sym of['SPY','QQQ','IWM','VIX']){
      try{
        var d=await apiFetch(FH_BASE+'/quote?symbol='+sym+'&token='+FH_KEY);
        var pe=document.getElementById('p-'+sym+'-p'), ce=document.getElementById('p-'+sym+'-c');
        if(pe) pe.textContent='$'+d.c.toFixed(2);
        if(ce){var ch=(d.c-d.o)/d.o*100;ce.textContent=(ch>=0?'+':'')+ch.toFixed(2)+'%';ce.style.color=ch>=0?'var(--green)':'var(--red)';}
      }catch(e){}
    }
    var ticks=[...new Set(stocks.map(function(s){return s.ticker;}))];
    for(var t of ticks){
      try{
        var q=await apiFetch(FH_BASE+'/quote?symbol='+t+'&token='+FH_KEY);
        prices[t]={c:q.c,o:q.o,h:q.h,l:q.l,pc:q.pc};
        var moS=moStart();
        var ca=await apiFetch(FH_BASE+'/stock/candle?symbol='+t+'&resolution=D&from='+moS+'&to='+Math.floor(Date.now()/1000)+'&token='+FH_KEY);
        if(ca.s==='ok'&&ca.c&&ca.c.length>0){
          moO[t]=ca.o[0];
          var mIdx=mondayIdx(ca.t);
          wkO[t]=ca.o[mIdx]||ca.o[0];
        }
      }catch(e){}
    }
    renderWL();
    document.getElementById('spin').style.display='none';
    document.getElementById('last-upd').textContent='Updated '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
  }

  function startRefTimer(){
    if(refTimer)clearInterval(refTimer);
    var bar=document.getElementById('rprog');
    refTimer=setInterval(function(){
      countdown--;
      if(bar) bar.style.width=(countdown/refInt*100)+'%';
      if(countdown<=0){countdown=refInt;if(autoRef&&LIVE)fetchAll();}
    },1000);
    countdown=refInt;
  }

  window.manualRef=function(){if(LIVE){fetchAll();countdown=refInt;}else showToast('Add Finnhub key in Settings for live prices','info');};
  window.toggleAR=function(){autoRef=!autoRef;document.getElementById('ar-tog').classList.toggle('on',autoRef);};
  window.updateRI=function(){refInt=parseInt(document.getElementById('ri-sel').value);countdown=refInt;startRefTimer();};

  // â”€â”€ TICKER LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.lookupTk=async function(){
    var t=document.getElementById('f-tk').value.trim().toUpperCase();
    if(!t){setLU('Enter a ticker first','err');return;}
    if(!FH_KEY){setLU('Add Finnhub key in Settings for lookup','');return;}
    var btn=document.getElementById('lu-btn');btn.disabled=true;btn.textContent='â³';
    try{
      var r=await fetch(FH_BASE+'/stock/profile2?symbol='+t+'&token='+FH_KEY);
      var d=await r.json();
      if(d.name){
        document.getElementById('f-co').value=d.name;
        var sectorMap={'Technology':'Technology','Software':'Technology','Semiconductors':'Technology','Internet':'Technology','Healthcare':'Healthcare','Biotech':'Healthcare','Pharmaceuticals':'Healthcare','Financial':'Financials','Bank':'Financials','Energy':'Energy','Oil':'Energy','Retail':'Consumer Disc.','Consumer':'Consumer Disc.'};
        var fi=d.finnhubIndustry||'';
        for(var k in sectorMap){if(fi.toLowerCase().includes(k.toLowerCase())){document.getElementById('f-se').value=sectorMap[k];break;}}
        setLU('âœ… '+d.name,'ok');
      }else setLU('Ticker not found','err');
    }catch(e){setLU('Lookup failed','err');}
    btn.disabled=false;btn.textContent='ğŸ” Lookup';
  };

  // â”€â”€ DATA HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function gp(t){return prices[t]&&prices[t].c||0;}
  function dp(t){var d=prices[t];return d?pct(d.c,d.o):null;}
  function wp(t){var d=prices[t];return d&&wkO[t]?pct(d.c,wkO[t]):null;}
  function mpp(t){var d=prices[t];return d&&moO[t]?pct(d.c,moO[t]):null;}
  function pct(c,b){if(!c||!b||b===0)return null;return(c-b)/b*100;}
  function fp(v){if(v===null||isNaN(v))return'â€”';return(v>=0?'+':'')+v.toFixed(2)+'%';}
  function pc(v){return v===null?'var(--muted)':v>0?'var(--green)':v<0?'var(--red)':'var(--muted)';}
  function pcl(v){return v===null?'':v>0?'tu':v<0?'td':'';}
  function sc(s){if(!s)return'';if(s.includes('1A')||s.includes('1B'))return's1b';if(s.includes('2C')||s.includes('Cont'))return's2c';if(s.includes('2'))return's2x';if(s.includes('3'))return's3x';if(s.includes('4'))return's4x';return's2x';}
  function sbc(s){if(!s)return'var(--green)';if(s.includes('1'))return'var(--gold)';if(s.includes('2'))return'var(--green)';if(s.includes('3'))return'var(--warn)';if(s.includes('4'))return'var(--red)';return'var(--green)';}
  function ha(s){var p=gp(s.ticker);if(!p)return false;if(s.alertA>0&&p>=s.alertA)return true;if(s.alertB>0&&p<=s.alertB)return true;return false;}
  function at(s){var p=gp(s.ticker);if(s.alertA>0&&p>=s.alertA)return'ğŸ””â‰¥$'+s.alertA;if(s.alertB>0&&p<=s.alertB)return'ğŸ””â‰¤$'+s.alertB;if(s.alertA>0)return'â†‘$'+s.alertA;if(s.alertB>0)return'â†“$'+s.alertB;return'';}
  function listPill(list){var map={weekly:'ğŸ“† Weekly',daily:'ğŸ•¯ Daily',ondeck:'ğŸ‘€ On Deck',rs:'âš¡ RS',all:''};var cls={weekly:'lp-weekly',daily:'lp-daily',ondeck:'lp-ondeck',rs:'lp-rs',all:'lp-all'};var lbl=map[list]||list;if(!lbl)return'';return'<span class="lpill '+(cls[list]||'lp-all')+'">'+lbl+'</span>';}

  // â”€â”€ TAB / VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.switchTab=function(tab,el){curTab=tab;document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});el.classList.add('active');renderWL();};
  window.setView=function(v){curView=v;document.getElementById('vbt').classList.toggle('active',v==='table');document.getElementById('vbc').classList.toggle('active',v==='card');renderWL();};

  function getFiltered(){
    var q=document.getElementById('srch').value.toLowerCase();
    var data=stocks.filter(function(s){
      var m=!q||s.ticker.toLowerCase().includes(q)||(s.company||'').toLowerCase().includes(q)||(s.sector||'').toLowerCase().includes(q);
      if(!m)return false;
      if(curTab==='all')return true;
      if(curTab==='alerts')return ha(s);
      return s.list===curTab;
    });
    var sort=document.getElementById('srt').value;
    data.sort(function(a,b){
      if(sort==='ticker')return(a.ticker||'').localeCompare(b.ticker||'');
      if(sort==='daily_d')return(dp(b.ticker)||0)-(dp(a.ticker)||0);
      if(sort==='daily_a')return(dp(a.ticker)||0)-(dp(b.ticker)||0);
      if(sort==='weekly_d')return(wp(b.ticker)||0)-(wp(a.ticker)||0);
      if(sort==='monthly_d')return(mpp(b.ticker)||0)-(mpp(a.ticker)||0);
      if(sort==='price_d')return(gp(b.ticker)||0)-(gp(a.ticker)||0);
      if(sort==='rs_d')return(b.rs||0)-(a.rs||0);
      return(b.id||0)-(a.id||0);
    });
    return data;
  }

  function updateCounts(){
    document.getElementById('c-all').textContent=stocks.length;
    ['weekly','daily','ondeck','rs'].forEach(function(l){
      document.getElementById('c-'+l).textContent=stocks.filter(function(s){return s.list===l;}).length;
    });
    document.getElementById('c-alerts').textContent=stocks.filter(ha).length;
  }

  function renderSum(){
    var data=getFiltered(),el=document.getElementById('ssum');
    // Banner
    var meta=LIST_META[curTab]||LIST_META.all;
    var banner='<div class="list-banner '+meta.cls+'" style="width:100%;margin-bottom:12px;"><div class="lb-icon">'+meta.icon+'</div><div><div class="lb-title" style="color:'+meta.color+'">'+meta.label+'</div><div class="lb-desc">'+meta.desc+'</div></div><div style="margin-left:auto;font-size:22px;font-weight:900;color:'+meta.color+'">'+data.length+'</div></div>';

    if(!data.length){el.innerHTML=banner;return;}
    var hd=data.filter(function(s){return dp(s.ticker)!==null;});
    var bd=hd.length?hd.reduce(function(m,s){return dp(s.ticker)>dp(m.ticker)?s:m;}):null;
    var wd=hd.length?hd.reduce(function(m,s){return dp(s.ticker)<dp(m.ticker)?s:m;}):null;
    var ad=hd.length?hd.reduce(function(s,x){return s+dp(x.ticker);},0)/hd.length:null;
    var wins=hd.filter(function(s){return dp(s.ticker)>0;}).length,loss=hd.filter(function(s){return dp(s.ticker)<0;}).length;
    // RS-specific: show top RS rating
    var topRS=curTab==='rs'&&data.length?data.slice().sort(function(a,b){return(b.rs||0)-(a.rs||0);})[0]:null;
    el.innerHTML=banner+
      '<div class="ssc"><div class="ssl">Watching</div><div class="ssv" style="color:'+meta.color+'">'+data.length+'</div><div class="sss">'+wins+'â†‘ '+loss+'â†“</div></div>'+
      (bd?'<div class="ssc"><div class="ssl">Best Today</div><div class="ssv" style="color:var(--green)">'+bd.ticker+'</div><div class="sss" style="color:var(--green)">'+fp(dp(bd.ticker))+'</div></div>':'')+
      (wd?'<div class="ssc"><div class="ssl">Worst Today</div><div class="ssv" style="color:var(--red)">'+wd.ticker+'</div><div class="sss" style="color:var(--red)">'+fp(dp(wd.ticker))+'</div></div>':'')+
      (ad!==null?'<div class="ssc"><div class="ssl">Avg Daily</div><div class="ssv" style="color:'+(ad>=0?'var(--green)':'var(--red)')+'">'+fp(ad)+'</div></div>':'')+
      (topRS?'<div class="ssc"><div class="ssl">Top RS Stock</div><div class="ssv" style="color:var(--teal)">'+topRS.ticker+'</div><div class="sss" style="color:var(--teal)">RS '+topRS.rs+'</div></div>':'');
  }

  function renderWL(){
    var data=getFiltered();updateCounts();renderSum();
    var el=document.getElementById('wl');
    if(!data.length){el.innerHTML='<div class="empty"><div class="empty-icon">'+(LIST_META[curTab]||{icon:'ğŸ“‹'}).icon+'</div><h3>No stocks in '+((LIST_META[curTab]||{label:'this list'}).label)+'</h3><p>Click "ï¼‹ Add Stock" to add to this list.</p></div>';return;}
    if(curView==='table') renderTbl(data,el); else renderCds(data,el);
  }

  function renderTbl(data,el){
    function bar(v){if(v===null)return'';var w=Math.min(Math.abs(v)*3,48);return'<span class="pbar2 '+(v>=0?'pu':'pd')+'" style="width:'+w+'px"></span>';}
    function cell(v){if(v===null)return LIVE?'<span class="sk"></span>':'â€”';return'<div class="'+pcl(v)+'">'+fp(v)+'</div><div>'+bar(v)+'</div>';}
    var showList=(curTab==='all');
    el.innerHTML='<div class="tw"><table><thead><tr>'+
      '<th>#</th><th>Stock</th><th>Sector</th>'+
      (showList?'<th>List</th>':'')+
      '<th>Stage</th><th>Price</th>'+
      '<th style="color:var(--accent)">Day %</th><th>Week %</th><th>Month %</th>'+
      '<th>EMA</th><th>RS</th>'+
      (curTab==='rs'?'<th>RS New High</th>':'')+
      (curTab==='weekly'?'<th>Setup</th>':'')+
      '<th>Alert</th><th>Notes</th><th></th>'+
      '</tr></thead><tbody>'+
      data.map(function(s,i){
        var price=gp(s.ticker),dv=dp(s.ticker),wv=wp(s.ticker),mv=mpp(s.ticker),alt=at(s),alth=ha(s);
        return'<tr>'+
          '<td style="color:var(--muted)">'+(i+1)+'</td>'+
          '<td><div style="font-weight:800;font-size:13px">'+s.ticker+'</div><div style="color:var(--muted);font-size:11px">'+(s.company||'')+'</div></td>'+
          '<td><span class="stag">'+(s.sector||'â€”')+'</span></td>'+
          (showList?'<td>'+listPill(s.list)+'</td>':'')+
          '<td><span class="sbadge '+sc(s.stage)+'">'+(s.stage||'â€”')+'</span></td>'+
          '<td><div style="font-weight:800">'+(price>0?'$'+price.toFixed(2):LIVE?'<span class="sk"></span>':'â€”')+'</div></td>'+
          '<td>'+cell(dv)+'</td>'+
          '<td>'+cell(wv)+'</td>'+
          '<td>'+cell(mv)+'</td>'+
          '<td><span class="emd '+(s.ema==='yes'?'eo':'enb')+'"></span><span class="emd '+(s.a50==='yes'?'eo':'enb')+'" style="margin-left:3px"></span></td>'+
          '<td>'+(s.rs?'<div style="font-size:12px;font-weight:700;color:'+(s.rs>=80?'var(--green)':s.rs>=60?'var(--warn)':'var(--muted)')+'">'+s.rs+'</div><div class="rsb"><div class="rsf" style="width:'+s.rs+'%"></div></div>':'â€”')+'</td>'+
          (curTab==='rs'?'<td>'+(s.rsh==='yes'?'<span style="color:var(--teal);font-weight:700">âœ… RS New High</span>':'â€”')+'</td>':'')+
          (curTab==='weekly'?'<td><span class="stag">'+(s.wf||'â€”')+'</span></td>':'')+
          '<td>'+(alt?'<span class="ab '+(alth?'ab-h':s.alertA>0?'ab-a':'ab-b')+'">'+alt+'</span>':'â€”')+'</td>'+
          '<td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;color:var(--muted);font-size:11px">'+(s.notes||'â€”')+'</td>'+
          '<td><button class="ed" onclick="openEdit('+s.id+')">âœï¸</button><button class="ed" onclick="delStk('+s.id+')" style="color:var(--red)">ğŸ—‘</button></td>'+
          '</tr>';
      }).join('')+'</tbody></table></div>';
  }

  function renderCds(data,el){
    el.innerHTML='<div class="cg">'+data.map(function(s){
      var price=gp(s.ticker),dv=dp(s.ticker),wv=wp(s.ticker),mv=mpp(s.ticker);
      return'<div class="scard"><div class="csb" style="background:'+sbc(s.stage)+'"></div>'+
        (ha(s)?'<div class="apd"></div>':'')+
        '<div class="ct"><div><div class="ctk">'+s.ticker+'</div><div class="ccn">'+(s.company||'')+'</div></div>'+
        '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">'+
        '<span class="sbadge '+sc(s.stage)+'">'+(s.stage||'â€”')+'</span>'+
        (s.sector?'<span class="stag">'+s.sector+'</span>':'')+
        listPill(s.list)+
        '</div></div>'+
        '<div class="cpr">'+(price>0?'$'+price.toFixed(2):LIVE?'<span class="sk" style="height:20px;width:85px"></span>':'â€”')+'</div>'+
        '<div class="cpf">'+
        '<div class="cpe"><div class="cpl">Daily</div><div class="cpv" style="color:'+pc(dv)+'">'+fp(dv)+'</div></div>'+
        '<div class="cpe"><div class="cpl">Weekly</div><div class="cpv" style="color:'+pc(wv)+'">'+fp(wv)+'</div></div>'+
        '<div class="cpe"><div class="cpl">Monthly</div><div class="cpv" style="color:'+pc(mv)+'">'+fp(mv)+'</div></div>'+
        '</div>'+
        '<div class="cf">'+
        '<div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap">'+
        '<span class="emd '+(s.ema==='yes'?'eo':'enb')+'"></span>'+
        '<span class="emd '+(s.a50==='yes'?'eo':'enb')+'"></span>'+
        (s.rs?'<span style="font-size:11px;font-weight:700;color:'+(s.rs>=80?'var(--green)':s.rs>=60?'var(--warn)':'var(--red)')+'">RS '+s.rs+'</span>':'')+
        (s.rsh==='yes'?'<span style="font-size:10px;color:var(--teal);font-weight:700">â˜… RS New High</span>':'')+
        (at(s)?'<span class="ab '+(ha(s)?'ab-h':'ab-a')+'" style="font-size:10px">'+at(s)+'</span>':'')+
        '</div>'+
        '<div><button class="ed" onclick="openEdit('+s.id+')">âœï¸</button><button class="ed" onclick="delStk('+s.id+')" style="color:var(--red)">ğŸ—‘</button></div>'+
        '</div>'+
        (s.notes?'<div style="margin-top:7px;padding-top:7px;border-top:1px solid rgba(255,255,255,.05);font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+s.notes+'</div>':'')+
        (s.wf&&s.list==='weekly'?'<div style="margin-top:5px;font-size:10px;color:var(--gold)">ğŸ“† '+s.wf+'</div>':'')+
        '</div>';
    }).join('')+'</div>';
  }

  // â”€â”€ ADD / EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.openAdd=function(){
    editId=null;document.getElementById('mo-title').textContent='Add Stock';
    document.querySelectorAll('#stock-mo input,#stock-mo select,#stock-mo textarea').forEach(function(e){e.value='';});
    document.getElementById('f-st').value='Stage 2';
    document.getElementById('f-em').value='yes';
    document.getElementById('f-50').value='yes';
    document.getElementById('f-rsh').value='no';
    document.getElementById('f-li').value=(curTab==='all'||curTab==='alerts')?'all':curTab;
    setLU('','');document.getElementById('stock-mo').classList.add('open');document.getElementById('f-tk').focus();
  };
  window.openEdit=function(id){
    editId=id;var s=stocks.find(function(x){return String(x.id)===String(id);});if(!s)return;
    document.getElementById('mo-title').textContent='Edit '+s.ticker;
    document.getElementById('f-tk').value=s.ticker;
    document.getElementById('f-co').value=s.company||'';
    document.getElementById('f-se').value=s.sector||'';
    document.getElementById('f-li').value=s.list||'all';
    document.getElementById('f-st').value=s.stage||'Stage 2';
    document.getElementById('f-rs').value=s.rs||'';
    document.getElementById('f-em').value=s.ema||'yes';
    document.getElementById('f-50').value=s.a50||'yes';
    document.getElementById('f-aa').value=s.alertA||'';
    document.getElementById('f-ab').value=s.alertB||'';
    document.getElementById('f-nt').value=s.notes||'';
    document.getElementById('f-wf').value=s.wf||'';
    document.getElementById('f-rsh').value=s.rsh||'no';
    setLU('','');
    document.getElementById('stock-mo').classList.add('open');
  };
  window.closeSMo=function(){document.getElementById('stock-mo').classList.remove('open');editId=null;};

  window.saveStk=async function(){
    var ticker=document.getElementById('f-tk').value.trim().toUpperCase();
    if(!ticker){showToast('Enter a ticker','err');return;}
    var stock={
      id:editId||Date.now(),
      ticker:ticker,
      company:document.getElementById('f-co').value.trim(),
      sector:document.getElementById('f-se').value,
      list:document.getElementById('f-li').value||'all',
      stage:document.getElementById('f-st').value,
      rs:parseInt(document.getElementById('f-rs').value)||0,
      ema:document.getElementById('f-em').value,
      a50:document.getElementById('f-50').value,
      alertA:parseFloat(document.getElementById('f-aa').value)||0,
      alertB:parseFloat(document.getElementById('f-ab').value)||0,
      notes:document.getElementById('f-nt').value.trim(),
      wf:document.getElementById('f-wf').value,
      rsh:document.getElementById('f-rsh').value,
      addedDate:editId?(stocks.find(function(s){return String(s.id)===String(editId);})||{}).addedDate:new Date().toISOString().split('T')[0]
    };
    if(editId){var i=stocks.findIndex(function(s){return String(s.id)===String(editId);});if(i>=0)stocks[i]=stock;}
    else stocks.unshift(stock);
    window.closeSMo();renderWL();setSyncStatus('spin','Saving...');
    try{await saveToBin();showToast(editId?ticker+' updated!':ticker+' added & synced! ğŸ“±ğŸ’»','success');}
    catch(e){showToast('âš ï¸ Saved locally, sync failed: '+e.message,'err');setSyncStatus('off','Sync error');}
  };

  window.delStk=async function(id){
    var s=stocks.find(function(x){return String(x.id)===String(id);});
    if(!s||!confirm('Remove '+s.ticker+'?'))return;
    stocks=stocks.filter(function(x){return String(x.id)!==String(id);});
    delete prices[s.ticker];delete wkO[s.ticker];delete moO[s.ticker];
    renderWL();setSyncStatus('spin','Saving...');
    try{await saveToBin();showToast(s.ticker+' removed','err');}
    catch(e){showToast('Removed locally, sync failed','err');}
  };

  // â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.openSettings=function(){document.getElementById('set-fh').value=FH_KEY;document.getElementById('set-jb').value=JB_KEY;document.getElementById('set-mo').classList.add('open');};
  window.closeSet=function(){document.getElementById('set-mo').classList.remove('open');};
  window.updateFH=async function(){var k=document.getElementById('set-fh').value.trim();if(!k)return;FH_KEY=k;LIVE=true;localStorage.setItem('fh_key',k);try{await saveToBin();}catch(e){}showToast('âœ… Finnhub key saved!','success');fetchAll();startRefTimer();};
  window.updateJB=async function(){var k=document.getElementById('set-jb').value.trim();if(!k)return;JB_KEY=k;localStorage.setItem('jb_key',k);showToast('âœ… JSONBin key updated!','success');pullFromBin();};
  window.clearAll=async function(){if(!confirm('Delete ALL stocks from all devices?'))return;stocks=[];await saveToBin();prices={};wkO={};moO={};window.closeSet();renderWL();showToast('All stocks deleted','err');};
  window.resetAll=function(){if(!confirm('Reset all keys and restart?'))return;localStorage.clear();location.reload();};

  // â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown',function(e){
    if(e.key==='Escape'){window.closeSMo();window.closeSet();}
    if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();var s=document.getElementById('srch');if(s)s.focus();}
  });
  document.getElementById('stock-mo').addEventListener('click',function(e){if(e.target===document.getElementById('stock-mo'))window.closeSMo();});
  document.getElementById('set-mo').addEventListener('click',function(e){if(e.target===document.getElementById('set-mo'))window.closeSet();});

  // â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(FH_KEY || localStorage.getItem('fh_skipped')) {
    launchApp();
  } else {
    document.getElementById('fh-screen').style.display='flex';
  }

})();
</script>
</body>
</html>